name: BUILD

on:
  push:
  schedule:
    - cron: "1 */8 * * *"

jobs:
  buildAUR:
    strategy:
      matrix:
        repos:
          [
            visual-studio-code-bin,
            mihomo-party,
            go-musicfox-bin,
            google-chrome,
            pyprland-git,
            linuxqq,
            wechat,
            wechat-bin,
            bun-bin,
          ]
        # include:
        #   - repos: git-cola
        #     preinstall-pkgs: "at-spi2-core"
        #   - repos: realesrgan-ncnn-vulkan
        #     preinstall-pkgs: "vulkan-intel"

      fail-fast: false

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # 缓存已构建的包
      - name: Cache built packages
        id: cache-pkg
        uses: actions/cache@v4
        with:
          path: ./*/*.pkg.tar.zst
          key: aur-${{ matrix.repos }}-${{ hashFiles('**/*.SRCINFO', '**/PKGBUILD') }}-${{ github.run_number }}
          restore-keys: |
            aur-${{ matrix.repos }}-${{ hashFiles('**/*.SRCINFO', '**/PKGBUILD') }}-
            aur-${{ matrix.repos }}-

      - name: Build AUR package
        if: steps.cache-pkg.outputs.cache-hit != 'true'
        uses: ./build-aur-action
        with:
          repo-name: ${{ matrix.repos }}
          # preinstallPkgs: ${{ matrix.preinstall-pkgs }}

      - uses: actions/upload-artifact@v4
        with:
          path: ./*/*.pkg.tar.zst
          name: ${{ matrix.repos }}
          if-no-files-found: error

      - uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          tag: "packages"
          artifacts: "./*/*.zst"
          token: ${{ secrets.GITHUB_TOKEN }}

  buildNonAUR:
    strategy:
      matrix:
        repos: [wlroots-0.19-git, cloud-pyprland]

      fail-fast: false

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # 缓存已构建的 nonaur 包
      - name: Cache built packages
        id: cache-pkg
        uses: actions/cache@v4
        with:
          path: ./*/*.pkg.tar.zst
          key: nonaur-${{ matrix.repos }}-${{ hashFiles(format('nonaur-pkgbuilds/{0}/PKGBUILD', matrix.repos)) }}-${{ github.run_number }}
          restore-keys: |
            nonaur-${{ matrix.repos }}-${{ hashFiles(format('nonaur-pkgbuilds/{0}/PKGBUILD', matrix.repos)) }}-
            nonaur-${{ matrix.repos }}-

      - name: Build NonAUR package
        if: steps.cache-pkg.outputs.cache-hit != 'true'
        uses: ./build-nonaur-action
        with:
          pkgdir: nonaur-pkgbuilds/${{ matrix.repos }}

      - uses: actions/upload-artifact@v4
        with:
          path: ./*/*.pkg.tar.zst
          name: ${{ matrix.repos }}
          if-no-files-found: error

      - uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          tag: "packages"
          artifacts: "./*/*.zst"
          token: ${{ secrets.GITHUB_TOKEN }}

  uploadToOSS:
    runs-on: ubuntu-latest
    if: always()
    needs: [buildAUR, buildNonAUR]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        id: download

      - name: Display structure of downloaded files
        run: ls -R ${{ steps.download.outputs.download-path }}

      - uses: ./create-db-and-upload-action
        with:
          S3_ENDPOINT_URL: "https://s3-cn-north-1.qiniucs.com"
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          S3_REGION: "cn-north-1"
          dest_path: archrepo
          repo_name: vifly
          gpg-privatekey: ${{ secrets.gpg_private_key }}
          local_path: ${{ steps.download.outputs.download-path }}

      - uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          tag: "packages"
          artifacts: "./upload_packages/*.sig,./upload_packages/*.files,./upload_packages/*.db,./upload_packages/*.tar.gz"
          token: ${{ secrets.GITHUB_TOKEN }}
